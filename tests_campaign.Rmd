---
title: "tests_campaign"
author: "Andi Ahlers"
date: '2022-06-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages}
rm(list = ls())
library(data.table)
source("ivregress.R")
```


```{r read in data}
df1 <- fread("../twitterads/data_ukraine/users_treatment.csv")
df1 <- df1[,c("id_str", "group", "condition")]

df2 <- fread("../twitterads/data_ukraine/temp_reach_avgs.csv")

full_df <- merge(df1, df2, by = "group")
```

```{r simulate outcome}
set.seed(1)
full_df[condition == "t", `:=`(outcome = rnorm(.N, .1, 1), assign = 1.0, cov = rnorm(.N, 0, .01))]
full_df[condition == "c", `:=`(outcome = rnorm(.N, 0, 1), assign = 0.0, cov = rnorm(.N, 0, .01))]

#full_df[condition == "c", avg_reach := 0]

```

```{r add control group to ad group level outcome}
set.seed(1)
df2[, `:=`(assign = 1.0, cov = rnorm(.N, 0, .01))]

c_df <- copy(df2)
set.seed(1)
c_df[, `:=`(avg_reach = 0, assign = 0.0, cov = rnorm(.N, 0, .01))]

group_df <- rbind(df2, c_df)

```

Z: Treatment Assignment
D: Treatment Received (Compliance/Non-Compliance)
Y: Outcome 

Z serves as the instrument

```{r set dfs}
df_temp <- copy(full_df)
df_temp[,avg_reach:=NA]

S1 <- df_temp
S2 <- group_df

df_3 <- copy(full_df)
df_3[condition == "c", avg_reach := 0]

S_1 <- df_3
S_2 <- df_3
```

where:
* S1 is the dataframe with sample 1 - this may not have the endogenous variable
* S2 is the dataframe with sample 2 - this may not have the dependent variable
* y_var is the name of dependent variable
* regs is the list of regressors or independent variables
* ev is endogenous variable provided as a list with 1 element
* inst is the list of exogenous instruments

```{r ts 2sls}

#%% t2sls - single instrument
y_var <- "outcome"
regs <- c("cov", "avg_reach") 
ev <- "avg_reach"
inst <- "assign"

#Two Sample Two Stage with Group Level as Sample 2
result <- ts2sls(S1, S2, y_var, regs, ev, inst)
print(result[1])
x_preds <- data.frame(result[2])

#Two Sample Two Stage with All Individual Level (Same Sample)
result_ind <- ts2sls(S_1, S_2, y_var, regs, ev, inst)
print(result_ind[1])
x2_preds <- data.frame(result_ind[2])

#try_lm <- lm(outcome ~ avg_reach, data = full_df)
#summary(try_lm)

#regular 2SLS where users in same ad group are assigned same reach value
res_1sample <- ivregress_2sls(df_3, y_var, regs, ev, inst, verbose = FALSE)
print(res_1sample)

.07/.015
.676/.144
.51/.126

```


#%% iveregress - single instrument

S <- df2
y_var  <- "price"
regs <- c("weight", "mpg")
ev <- "mpg"
inst <- "headroom"
result <- ivregress_2sls(S, y_var, regs, ev, inst, verbose = T)
result





```{r check auto data}

df1 <- fread("auto_data.csv")
df1[, weight2 := weight * weight]
df2 <- copy(df1)
df1$mpg <- NA

S1 <- df1
S2 <- df2

#%% iveregress - single instrument

S <- df2
y_var  <- "price"
regs <- c("weight", "mpg")
ev <- "mpg"
inst <- "headroom"
result <- ivregress_2sls(S, y_var, regs, ev, inst, verbose = T)
result

#%% t2sls - single instrument

y_var <- "price"
regs <- c("weight", "mpg")
ev <- "mpg"
inst <- "headroom"
result <- ts2sls(S1, S2, y_var, regs, ev, inst)
print(result)

```

## Two Stage Bootstrap

**Two stage**

```{r}
library(MASS)  

df1 <- fread("../twitterads/data_ukraine/users_treatment.csv")
df1 <- df1[,c("id_str", "group", "condition")]

set.seed(02139)
Z <- rep(c(0, 1), 27)
D <- rbeta(54,2,5) * 0.4
D[Z == 0] <- 0
Y <- floor(rbeta(17049, 1, 50) * 100)

df1$Y <- Y


df2 <- data.frame(Z, D, rep(seq(1, 27), each = 2), rep(c("c", "t"), 27), seq(1, 54))
names(df2) <- c("Z", "D", "group", "condition", "group_name")

# currently no fixed effect involved
glm_2stage <- function(df1, df2){
  stage1 <- glm(D~Z, df2, family = "gaussian")
  stage1_predicted <- predict.lm(stage1, df2)
  
  # estimate D_hat
  df <- left_join(df1, df2, by = c("group", "condition"))
  df$D_hat <- sapply(df$group_name, function(x) stage1_predicted[x])
  # set D_hat to 0 for control group (?)
  df$D_hat <- ifelse(df$condition == "c", 0, df1$D_hat)
  
  # calculate residuals for residuals inclusion
  df$residuals <- sapply(df$group_name, function(x) stage1$residuals[x])
  
  stage2 <- glm(Y ~ D_hat + residuals, df, family = "quasipoisson")
  return(summary(stage2)$coefficients)
}
```

**Bootstrap**

```{r}
B <- 100
coefficients <- list()
pairwise <- TRUE
for (b in 1:B){
  # sample ad group level data frame
  if (pairwise){
    trt_idx <- sample(1:27, 27, replace = T)
    df2_b <- rbind(df2[df2$condition == "t",][trt_idx, ], df2[df2$condition == "c",][trt_idx, ])
  } else{
    trt_idx <- sample(1:27, 27, replace = T)
    ctr_idx <- sample(1:27, 27, replace = T)
    df2_b <- rbind(df2[df2$condition == "t",][trt_idx, ], df2[df2$condition == "c",][ctr_idx, ])
  }
  
  # sample individual level data frame
  # currently no sample by block involved
  df1_b <- c()
  # re-sample within each ad group
  for (i in 1:nrow(df2_b)){
    cdt <- df2_b$condition[i]
    grp <- df2_b$group[i]
    tmp <- df1 %>% filter(condition == cdt) %>% filter(group == grp)
    idx <- sample(1:nrow(tmp), nrow(tmp), replace = T)
    df1_b <- rbind(df1_b, tmp[idx, ])
    
  }
  coefficients[[b]] <- glm_2stage(df1_b, df2_b)
  
}

```


